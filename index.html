<style>
.sprite-image {
  height:64px;
  width:64px;
}
.dudes img {

  margin-right:8px;
}
.template {
  visibility: hidden;
  display: none;
}
</style>
<script type="text/javascript" src="http://www.parsecdn.com/js/parse-1.2.19.min.js"></script>
<img class="sprite-image"></img>
<br>

<div class="background-colour">
  <label>Background colour</label>
  <input value="#ffffff" type="color"></input>
</div>
<div class="skin-colour">
  <label>Skin colour</label>
  <input value="#000000" type="color"></input>
</div>
<div class="eye-colour">
  <label>Eye colour</label>
  <input value="#ffff00" type="color"></input>
</div>
<div class="shirt-colour">
  <label>Shirt colour</label>
  <input value="#995500" type="color"></input>
</div>
<div class="pants-colour">
  <label>Pants colour</label>
  <input value="#995500" type="color"></input>
</div>
<div class="belt-colour">
  <label>Belt colour</label>
  <input value="#663300" type="color"></input>
</div>
<div class="buckle-colour">
  <label>Belt buckle colour</label>
  <input value="#999999" type="color"></input>
</div>
<div class="hat-colour">
  <label>Hat colour</label>
  <input value="#995500" type="color"></input>
</div>
<div class="boots-colour">
  <label>Boots colour</label>
  <input value="#995500" type="color"></input>
</div>
<div class="weapon-colour">
  <label>Weapon colour</label>
  <input value="#999999" type="color"></input>
</div>
<div class="weapon-style">
  <label>Weapon style</label>
  <select>
    <option value="knife">Knife</option>
    <option value="sword" selected>Sword</option>
    <option value="staff">Staff</option>
    <option value="none">None</option>
  </select>
</div>
<div class="shirt-style">
  <label>Shirt style</label>
  <select>
    <option value="robe">Robe</option>
    <option value="shirt" selected>Normal</option>
  </select>
</div>

<button class="save-dude">save dude</button>
<br>
Other dudes
<div class="dudes"></div>

<script>
Parse.initialize("QKd4Bi5syX0TSnmdJefTaehNJrXa7M0Qweu5lAMt", "izFh0K1jsaX0jeZfWXKo1ZUSGkvuYTBmqREhQ4Ns");
document.addEventListener("DOMContentLoaded", function() {
  var images = "skin,eye,shirt,pants,belt,buckle,hat,boots,sword,knife,staff,robe".split(",");
  var loadingImages = images.length;
  images.forEach( function(image) {
    var img = document.createElement("img");
    document.body.appendChild(img);
    img.classList.add("template");
    img.classList.add(image);
    img.addEventListener("load", function() {
      loadingImages--;
      if (loadingImages === 0) {
        ready();
      }
    });
    img.src = image + ".png";
  });

  function ready() {
    var parts = "skin,eye,pants,belt,buckle,hat,boots,shirt".split(",");
    var spriteImage = document.querySelector(".sprite-image");

    var backgroundColour = document.querySelector(".background-colour input").value;
    window.shirtStyle = document.querySelector(".shirt-style select").value;

    for (var p = 0; p < parts.length; p++) {
      var part = parts[p];
      window[part + "Colour"] = document.querySelector("." + part + "-colour input").value;
      if (window[part + "Style"]) {
        window[part + "Data"] = getDataFromImage("." + window[part + "Style"]);
      } else {
        window[part + "Data"] = getDataFromImage("." + part);
      }
    }

    var weaponStyle = document.querySelector(".weapon-style select").value;
    var weaponColour = document.querySelector(".weapon-colour input").value;
    var weaponData = [];
    if (weaponStyle !== "none") {
      weaponData = getDataFromImage("." + weaponStyle);
    }
    //var weaponColour = document.querySelector(".weapon-colour input").value;
    /*var weaponData = [];
    if (weaponStyle !== "none") {
      weaponData = getDataFromImage("." + weaponStyle);
    }*/


    var canvas = document.createElement("canvas");
    canvas.height = 64;
    canvas.width = 64;
    var ctx = canvas.getContext("2d");

    function getDataFromImage(imgSelector) {
      var img = document.querySelector(imgSelector);
      var thisCanvas = document.createElement("canvas");
      thisCanvas.height = 8;
      thisCanvas.width = 8;
      var thisCtx = thisCanvas.getContext("2d");
      thisCtx.drawImage(img, 0, 0, 8, 8);
      var pixelData = thisCtx.getImageData(0, 0, 8, 8);
      var data = pixelData.data;
      return data;
    }

    function darken(colour) {
      var darker = "#";
      var depth = 1;

      for (var i = 1; i < colour.length; i+=2) {
        var step = colour[i] + colour[i+1];
        if (step === "00") {
          depth++;
        }
      }

      for (var i = 1; i < colour.length; i++) {
        var working = colour[i];
        working = parseInt(working, 16);
        for (var d = 0; d < depth; d++) {
          if (working > 0) {
            working-=1;
          }
        }
        working = working.toString(16);
        darker += working.toString(16);
      }
      return darker;
    }

    function drawPixelsFromData(fillStyle, pixelData) {
      var light = fillStyle;
      var dark = darken(fillStyle);

      for(var y = 0; y < 8; y++) {
        for(var x = 0; x < 8; x++) {
          if (pixelData[((8 * y) + x) * 4] === 0) {
            ctx.fillStyle = dark;
            ctx.fillRect(x*8, y*8, 8, 8);
          } else if (pixelData[((8 * y) + x) * 4] !== 255) {
            ctx.fillStyle = light;
            ctx.fillRect(x*8, y*8, 8, 8);
          }
        }
      }
    }

    document.querySelector(".background-colour input").addEventListener("change", function() {
      backgroundColour = this.value;
      render();
    });

    document.querySelector(".weapon-colour input").addEventListener("change", function() {
      weaponColour = this.value;
      render();
    });

    document.querySelector(".weapon-style select").addEventListener("change", function() {
      weaponStyle = this.value;
      if (weaponStyle !== "none") {
        weaponData = getDataFromImage("." + weaponStyle);
      }
      render();
    });

    document.querySelector(".shirt-style select").addEventListener("change", function() {
      window.shirtStyle = this.value;
      window["shirtData"] = getDataFromImage("." + window["shirtStyle"]);
      render();
    });

    parts.forEach( function(part) {
      document.querySelector("." + part + "-colour input").addEventListener("change", function() {
        window[part + "Colour"] = this.value;
        render();
      });
      window["draw" + part] = function() {
        drawPixelsFromData(window[part + "Colour"], window[part + "Data"]);
      };
    });

    function drawBackground() {
      ctx.fillStyle = backgroundColour;
      ctx.fillRect(0, 0, 64, 64);
    }

    function drawWeapon() {
      if (weaponStyle !== "none") {
        drawPixelsFromData(weaponColour, weaponData);
      }
    }

    function render() {
      drawBackground();
      parts.forEach( function(part) {
        window["draw" + part]();
      });
      drawWeapon();
      spriteImage.src = canvas.toDataURL();
    }
    render();
    function generateDudes() {
      var dudes = document.querySelector(".dudes");
      dudes.innerHTML = "";
      var TestObject = Parse.Object.extend("DudesTest");
      //var testObject = new TestObject();
      var query = new Parse.Query(TestObject);
      //console.log(testObject.get("src"));
      query.find({
        success: function(results) {
          console.log("Successfully retrieved " + results.length + " dudes.");
          // Do something with the returned Parse.Object values
          for (var i = results.length-1; i >= 0; i--) {
          //for (var i = 0; i < results.length; i++) {
            var object = results[i];
            var img = document.createElement("img");
            img.src = object.get("src");
            dudes.appendChild(img);
          }
        },
        error: function(error) {
          console.log("Error: " + error.code + " " + error.message);
        }
      });
    }
    generateDudes();
    document.querySelector(".save-dude").addEventListener("click", function() {
      var TestObject = Parse.Object.extend("DudesTest");
      var testObject = new TestObject();
      testObject.save({src: spriteImage.src}).then(function(object) {
        generateDudes();
      });

    });
  }
});
</script>